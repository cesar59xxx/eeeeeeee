# Troubleshooting: UUID Error "invalid input syntax for type uuid: 'default'"

## Problem

Error when creating WhatsApp sessions:
\`\`\`
invalid input syntax for type uuid: "default"
\`\`\`

## Root Cause

The error occurs when the backend tries to insert an `id` field with value "default" into the `whatsapp_sessions` table, but the `id` column expects a UUID generated by the database.

## Solution

### 1. Verify Backend Code

The backend **should NOT send `id` in the insert**. Check `server/index.js` line ~300:

**CORRECT:**
\`\`\`javascript
const { data: newSession, error } = await supabase
  .from("whatsapp_sessions")
  .insert([{
    session_id: sessionId,  // ✅ Custom session identifier
    name: name,             // ✅ User-provided name
    tenant_id: tenantId || "default",  // ✅ Tenant ID
    status: "pending",
    created_at: new Date().toISOString(),
    // ❌ NO 'id' field here!
  }])
\`\`\`

**INCORRECT:**
\`\`\`javascript
const { data: newSession, error } = await supabase
  .from("whatsapp_sessions")
  .insert([{
    id: "default",  // ❌ WRONG! Causes UUID error
    session_id: sessionId,
    name: name,
    // ...
  }])
\`\`\`

### 2. Clear Railway Cache

The issue might be that Railway is still running an old version of the code:

1. Go to Railway dashboard
2. Click on your backend service
3. Go to **Settings** → **Danger Zone**
4. Click **Restart Service**
5. Wait 2-3 minutes for the new deployment

### 3. Verify Supabase Schema

Ensure the table has the correct structure:

\`\`\`sql
-- Check current schema
SELECT column_name, data_type, column_default
FROM information_schema.columns
WHERE table_name = 'whatsapp_sessions'
ORDER BY ordinal_position;
\`\`\`

Expected columns:
- `id` - UUID - DEFAULT uuid_generate_v4()
- `session_id` - TEXT - (custom identifier)
- `name` - TEXT
- `tenant_id` - TEXT
- `status` - TEXT
- `phone_number` - TEXT (optional)
- `qr_code` - TEXT (optional)
- `created_at` - TIMESTAMP

### 4. Test with cURL

Test the endpoint directly to see exactly what's being sent:

\`\`\`bash
curl -X POST https://your-railway-url.up.railway.app/api/whatsapp/sessions \
  -H "Content-Type: application/json" \
  -d '{"name": "test-session"}'
\`\`\`

Expected response:
\`\`\`json
{
  "success": true,
  "session": {
    "id": "UUID-HERE",
    "sessionId": "session-1234567890",
    "name": "test-session",
    "status": "pending"
  }
}
\`\`\`

### 5. Check Frontend Code

Verify the frontend is not sending `id`:

**Frontend (`app/(dashboard)/whatsapp/page.tsx`):**
\`\`\`typescript
const handleCreateSession = async () => {
  const result = await apiClient.createSession({ 
    name: newSessionName  // ✅ Only sending name
  })
}
\`\`\`

**API Client (`lib/api-client.ts`):**
\`\`\`typescript
async createSession(data: { name: string }) {
  return this.request("/api/whatsapp/sessions", {
    method: "POST",
    body: JSON.stringify(data),  // ✅ Only { name: "..." }
  })
}
\`\`\`

### 6. Verify Environment Variables

Make sure Railway has the correct Supabase credentials:

- `NEXT_PUBLIC_SUPABASE_URL` - Your Supabase URL
- `NEXT_PUBLIC_SUPABASE_ANON_KEY` - Public anon key
- `SUPABASE_SERVICE_ROLE_KEY` - Service role key (for server)

### 7. Check Railway Logs

View real-time logs to see exactly what's happening:

1. Go to Railway dashboard
2. Click on your backend service
3. Click **Logs** tab
4. Look for lines starting with `[v0]`

Expected logs when creating a session:
\`\`\`
[v0] Creating session: { name: 'test', tenantId: 'default', sessionId: 'session-...' }
[v0] Session created successfully: UUID-HERE
\`\`\`

Error logs if something is wrong:
\`\`\`
[v0] ERROR: Client sent 'id' in request body, this should never happen
[v0] Supabase insert error: { message: 'invalid input syntax for type uuid...' }
\`\`\`

## Prevention

Added validation in the latest code to reject any request that includes `id` in the body. This will help identify if the frontend is incorrectly sending an `id` field.

## Final Checklist

- [ ] Verified backend code does NOT send `id` in insert
- [ ] Restarted Railway service to clear cache
- [ ] Verified Supabase schema has UUID auto-generation
- [ ] Tested endpoint with cURL (success)
- [ ] Checked frontend only sends `name`
- [ ] Verified Railway environment variables
- [ ] Checked Railway logs for errors
- [ ] Frontend error resolved

If the error persists after all steps, share the Railway logs and I'll investigate further.
